#include "trellis.h"
#include "config.h"

// --- 全局变量定义 ---
double N0;
double sgm;

// --- 网格图常量定义 ---
// 4种可能的输出 (c1, c2)
const int state[4][2] = { {0,0},{0,1},{1,0},{1,1} }; 

// 为输出(c00, c01, c10, c11) 定义索引
// 使用宏定义而非 const int，以满足 MSVC C 编译器对数组初始化的要求
#define C00 0
#define C01 1
#define C10 2
#define C11 3

// 状态转移表 (定义8条边)
// {输入, 输出索引, 起始状态, 结束状态, 边ID}
line stateTable[line_num] = {
    // 状态 s(s1,s0) = 0(00)
    {0, C00, 0, 0, 1}, // 输入0 -> 输出(00), 下一状态 0(00)
    {1, C11, 0, 2, 2}, // 输入1 -> 输出(11), 下一状态 2(10)
    // 状态 s(s1,s0) = 1(01)
    {0, C11, 1, 0, 3}, // 输入0 -> 输出(11), 下一状态 0(00)
    {1, C00, 1, 2, 4}, // 输入1 -> 输出(00), 下一状态 2(10)
    // 状态 s(s1,s0) = 2(10)
    {0, C10, 2, 1, 5}, // 输入0 -> 输出(10), 下一状态 1(01)
    {1, C01, 2, 3, 6}, // 输入1 -> 输出(01), 下一状态 3(11)
    // 状态 s(s1,s0) = 3(11)
    {0, C01, 3, 1, 7}, // 输入0 -> 输出(01), 下一状态 1(01)
    {1, C10, 3, 3, 8}  // 输入1 -> 输出(10), 下一状态 3(11)
};

// 前向连接表 (用于 Viterbi ACS)
// pathConn[结束状态] = { {前一状态1, 对应边ID}, {前一状态2, 对应边ID} }
graph_connect pathConn[st_num] = {
    { {0,0}, {1,2} }, // 到达 S0 的路径：来自 S0 (边1) 或 S1 (边3)
    { {2,4}, {3,6} }, // 到达 S1 的路径：来自 S2 (边5) 或 S3 (边7)
    { {0,1}, {1,3} }, // 到达 S2 的路径：来自 S0 (边2) 或 S1 (边4)
    { {2,5}, {3,7} }  // 到达 S3 的路径：来自 S2 (边6) 或 S3 (边8)
};

// 后向连接表 (用于 BCJR Beta 计算)
// pathConnB[起始状态] = { {下一状态1, 对应边ID}, {下一状态2, 对应边ID} }
graph_connect pathConnB[st_num] = {
    { {0,0}, {2,1} }, // 从 S0 出发：去往 S0 (边1) 或 S2 (边2)
    { {0,2}, {2,3} }, // 从 S1 出发：去往 S0 (边3) 或 S2 (边4)
    { {1,4}, {3,5} }, // 从 S2 出发：去往 S1 (边5) 或 S3 (边6)
    { {1,6}, {3,7} }  // 从 S3 出发：去往 S1 (边7) 或 S3 (边8)
};